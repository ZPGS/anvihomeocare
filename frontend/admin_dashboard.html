<!doctype html>
<html lang="en">
<head>
  <title>SangamKripa HomeoCare â€“ Admin</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/style.css">
</head>

<body>

<header class="bento-header">
  <button class="hamburger" onclick="toggleMenu()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <h2 class="page-title">Admin</h2>
</header>

<!-- ================= SIDE PANEL ================= -->
<div id="sidePanel" class="side-panel">
  <h3>Doctor Settings</h3>

  <form id="settingsForm">
    <label>Doctor WhatsApp</label>
    <input id="doctor_whatsapp" placeholder="91XXXXXXXXXX">

    <label>Consultation Fee (â‚¹)</label>
    <input type="number" id="default_amount" placeholder="500">

    <label>UPI ID / Payment Link</label>
    <input id="upi_link" placeholder="example@upi">

    <button type="submit">Save Settings</button>
    <a href="#" id="logoutBtn" class="logout-btn">Logout</a>
  </form>
</div>

<main class="dashboard">

<!-- ================= STATS ================= -->
<section class="stats-bento">
  <div class="stat-card total"><span>Total</span><h1 id="stat-total">0</h1></div>
  <div class="stat-card reserved"><span>Reserved</span><h1 id="stat-reserved">0</h1></div>
  <div class="stat-card confirmed"><span>Confirmed</span><h1 id="stat-confirmed">0</h1></div>
  <div class="stat-card today"><span>Today</span><h1 id="stat-today">0</h1></div>
</section>

<!-- ================= APPOINTMENTS ================= -->
<section class="bento appointments-box">
  <h3>Appointments</h3>
  <div id="appointments" class="appointments-scroll"></div>
</section>

<!-- ================= SLOTS ================= -->
<section class="bento slots-box">
  <h3>Slots</h3>

  <form id="slotForm" class="slot-form">
    <input type="date" id="slot_date" required>
    <input type="time" id="start_time" required>
    <input type="time" id="end_time" required>
    <button type="submit">Add Slot</button>
  </form>

  <div id="slots" class="slots-grid"></div>
</section>

</main>

<footer>Â© 2026 Dr. HomeoCare â€¢ Online Homeopathy Consultation</footer>

<script>
const BACKEND = "https://anvihomeocare.onrender.com";
const TOKEN = localStorage.getItem("admin_token");

if (!TOKEN) {
  location.replace("/admin_login.html");
}

function toggleMenu() {
  document.getElementById("sidePanel").classList.toggle("open");
}

document.addEventListener("DOMContentLoaded", () => {

  const slotForm = document.getElementById("slotForm");
  const settingsForm = document.getElementById("settingsForm");
  const appointmentsDiv = document.getElementById("appointments");
  const slotsDiv = document.getElementById("slots");

  async function api(url, options = {}) {
    const res = await fetch(url, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + TOKEN,
        ...(options.headers || {})
      }
    });

    if (res.status === 401) {
      localStorage.removeItem("admin_token");
      location.replace("/admin_login.html");
      return null;
    }

    return res.json();
  }

  async function loadDashboard() {
    const data = await api(`${BACKEND}/api/admin/dashboard`);
    if (!data) return;

    document.getElementById("stat-total").innerText = data.stats.total;
document.getElementById("stat-reserved").innerText = data.stats.reserved;
document.getElementById("stat-confirmed").innerText = data.stats.confirmed;
document.getElementById("stat-today").innerText = data.stats.today;

    // settings
    doctor_whatsapp.value = data.settings.doctor_whatsapp || "";
    default_amount.value = data.settings.default_amount || "";
    upi_link.value = data.settings.upi_link || "";

    // appointments
    appointmentsDiv.innerHTML = "";

    data.appointments.forEach(a => {
      const receiptLink = `${BACKEND}/api/appointment/pdf/${a.confirmation_code}`;
      const meetingLink = a.meeting_link || "Will be shared soon";

      let waButton = "";

      if (a.status === "RESERVED") {
        const amount = data.settings.default_amount;
        const upiId = data.settings.upi_link;
        const upiPayLink = `upi://pay?pa=${upiId}&am=${amount}&cu=INR`;

        const text = `Hello ${a.patient_name},

Your appointment has been *RESERVED*.

ğŸ“… Date: ${a.appointment_date}
â° Time: ${a.slot_time}

ğŸ’° Consultation Fee: â‚¹${amount}

Please complete the payment using the UPI link below.

ğŸ“² Pay via UPI:
${upiPayLink}

UPI ID (manual):
${upiId}

Thank you,
Dr. Shweta Chandrakant Zungare`;

        waButton = `
          <a class="wa-btn" target="_blank"
             href="https://api.whatsapp.com/send?phone=${a.mobile}&text=${encodeURIComponent(text)}">
            ğŸ’° Send Payment Message
          </a>`;
      }

      if (a.status === "CONFIRMED") {
        const text = `Hello ${a.patient_name},

Your appointment has been *CONFIRMED* âœ…

ğŸ†” Code: ${a.confirmation_code}

ğŸ“… Date: ${a.appointment_date}
â° Time: ${a.slot_time}

ğŸ”— Meeting Link:
${meetingLink}

ğŸ§¾ Receipt:
${receiptLink}

Thank you,
Dr. Shweta Chandrakant Zungare`;

        waButton = `
          <a class="wa-btn" target="_blank"
             href="https://api.whatsapp.com/send?phone=${a.mobile}&text=${encodeURIComponent(text)}">
            ğŸ“² Send Confirmation
          </a>`;
      }

      appointmentsDiv.innerHTML += `
        <div class="appointment-card">
          <strong>${a.patient_name}</strong> (${a.mobile})<br>
          ${a.appointment_date} | ${a.slot_time}<br>
          <small>${a.confirmation_code}</small>

          <textarea id="r${a.id}" placeholder="Internal notes">${a.admin_remarks || ""}</textarea>
          <input id="m${a.id}" placeholder="Meeting link" value="${a.meeting_link || ""}">

          <select id="s${a.id}">
            ${["RESERVED","CONFIRMED","CANCELLED","DONE"]
              .map(s => `<option ${a.status===s?"selected":""}>${s}</option>`).join("")}
          </select>

          <div class="card-actions">
            <button class="update-btn" data-id="${a.id}">Update</button>
            ${waButton}
          </div>
        </div>`;
    });

    document.querySelectorAll(".update-btn").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        await api(`${BACKEND}/api/admin/update/${id}`, {
          method: "POST",
          body: JSON.stringify({
            status: document.getElementById("s"+id).value,
            meeting_link: document.getElementById("m"+id).value,
            remarks: document.getElementById("r"+id).value
          })
        });
        loadDashboard();
      };
    });

    // slots
    slotsDiv.innerHTML = "";
    data.slots.forEach(s => {
      slotsDiv.innerHTML += `
        <div class="slot-chip ${s.is_booked ? "booked" : ""}">
          <strong>${s.slot_date}</strong>
          <div>${s.start_time} â€“ ${s.end_time}</div>
          <small>${s.is_booked ? "BOOKED" : "FREE"}</small>
        </div>`;
    });
  }

  slotForm.onsubmit = async e => {
    e.preventDefault();
    await api(`${BACKEND}/api/admin/slots`, {
      method: "POST",
      body: JSON.stringify({
        slot_date: slot_date.value,
        start_time: start_time.value,
        end_time: end_time.value
      })
    });
    slotForm.reset();
    loadDashboard();
  };

  settingsForm.onsubmit = async e => {
    e.preventDefault();
    await api(`${BACKEND}/api/admin/settings`, {
      method: "POST",
      body: JSON.stringify({
        doctor_whatsapp: doctor_whatsapp.value,
        upi_link: upi_link.value,
        default_amount: default_amount.value
      })
    });
    alert("Settings saved");
  };

  logoutBtn.onclick = () => {
    localStorage.removeItem("admin_token");
    location.replace("/admin_login.html");
  };

  loadDashboard();
  setInterval(loadDashboard, 30000);
});
</script>

</body>
</html>
