<!doctype html>
<html lang="en">
<head>
  <title>SangamKripa HomeoCare ‚Äì Admin</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>

<body>

<header class="bento-header">
  <button class="hamburger" id="menuBtn" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <h2 class="page-title">Admin Dashboard</h2>
</header>

<!-- SIDE PANEL -->
<div id="sidePanel" class="side-panel">
  <h3>Doctor Settings</h3>

  <form id="settingsForm">
    <label>Doctor WhatsApp</label>
    <input id="doctor_whatsapp" placeholder="91XXXXXXXXXX" />

    <label>Consultation Fee (‚Çπ)</label>
    <input type="number" id="default_amount" placeholder="500" />

    <label>UPI ID</label>
    <input id="upi_link" placeholder="example@upi" />

    <button type="submit">Save Settings</button>
    <button type="button" id="logoutBtn" class="logout-btn">Logout</button>
  </form>
</div>

<main class="dashboard">

  <!-- STATS -->
  <section class="stats-bento">
    <div class="stat-card total"><span>Total</span><h1 id="stat-total">0</h1></div>
    <div class="stat-card reserved"><span>Reserved</span><h1 id="stat-reserved">0</h1></div>
    <div class="stat-card confirmed"><span>Confirmed</span><h1 id="stat-confirmed">0</h1></div>
    <div class="stat-card today"><span>Today</span><h1 id="stat-today">0</h1></div>
  </section>

  <!-- APPOINTMENTS -->
  <section class="bento appointments-box">
    <h3>Appointments</h3>
    <div id="appointments" class="appointments-scroll"></div>
  </section>

  <!-- SLOTS -->
  <section class="bento slots-box">
    <h3>Slots</h3>

    <form id="slotForm" class="slot-form">
      <input type="date" id="slot_date" required />
      <input type="time" id="start_time" required />
      <input type="time" id="end_time" required />
      <button type="submit">Add Slot</button>
    </form>

    <div id="slots" class="slots-grid"></div>
  </section>

</main>

<footer>¬© 2026 SangamKripa HomeoCare</footer>

<script>
/* =====================================================
   CONFIG
===================================================== */
const BACKEND = "https://anvihomeocare.onrender.com";
const TOKEN = localStorage.getItem("admin_token");

if (!TOKEN) {
  location.replace("/admin_login.html");
}

/* =====================================================
   HELPERS
===================================================== */
async function api(url, options = {}) {
  const res = await fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + TOKEN,
      ...(options.headers || {})
    }
  });

  if (res.status === 401) {
    localStorage.removeItem("admin_token");
    location.replace("/admin_login.html");
    return null;
  }

  return res.json();
}

/* =====================================================
   UI
===================================================== */
document.getElementById("menuBtn").onclick = () => {
  document.getElementById("sidePanel").classList.toggle("open");
};

document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("admin_token");
  location.replace("/admin_login.html");
};

/* =====================================================
   DASHBOARD LOAD
===================================================== */
async function loadDashboard() {
  const data = await api(`${BACKEND}/api/admin/dashboard`);
  if (!data) return;

  document.getElementById("stat-total").innerText = data.stats.total;
  document.getElementById("stat-reserved").innerText = data.stats.reserved;
  document.getElementById("stat-confirmed").innerText = data.stats.confirmed;
  document.getElementById("stat-today").innerText = data.stats.today;

  doctor_whatsapp.value = data.settings.doctor_whatsapp || "";
  default_amount.value = data.settings.default_amount || "";
  upi_link.value = data.settings.upi_link || "";

  renderAppointments(data.appointments, data.settings);
  renderSlots(data.slots);
}

/* =====================================================
   APPOINTMENTS
===================================================== */
function renderAppointments(list, settings) {
  const box = document.getElementById("appointments");
  box.innerHTML = "";

  list.forEach(a => {
    const amount = settings.default_amount || 0;
    const upi = settings.upi_link || "";

    let waBtn = "";

    if (a.status === "RESERVED") {
      const text = `Hello ${a.patient_name},

Your appointment has been *RESERVED*.

üìÖ ${a.appointment_date}
‚è∞ ${a.slot_time}

üí∞ Fee: ‚Çπ${amount}

UPI:
upi://pay?pa=${upi}&am=${amount}&cu=INR`;

      waBtn = `
        <a class="wa-btn" target="_blank"
           href="https://api.whatsapp.com/send?phone=${a.mobile}&text=${encodeURIComponent(text)}">
           üí∞ Send Payment
        </a>`;
    }

    box.innerHTML += `
      <div class="appointment-card">
        <strong>${a.patient_name}</strong> (${a.mobile})<br>
        ${a.appointment_date} | ${a.slot_time}<br>
        <small>${a.confirmation_code}</small>

        <textarea id="r${a.id}" placeholder="Remarks">${a.admin_remarks || ""}</textarea>
        <input id="m${a.id}" placeholder="Meeting link" value="${a.meeting_link || ""}">

        <select id="s${a.id}">
          ${["RESERVED","CONFIRMED","CANCELLED","DONE"]
            .map(s => `<option ${a.status===s?"selected":""}>${s}</option>`).join("")}
        </select>

        <button onclick="updateAppt(${a.id})">Update</button>
        ${waBtn}
      </div>
    `;
  });
}

async function updateAppt(id) {
  await api(`${BACKEND}/api/admin/update/${id}`, {
    method: "POST",
    body: JSON.stringify({
      status: document.getElementById("s"+id).value,
      meeting_link: document.getElementById("m"+id).value,
      remarks: document.getElementById("r"+id).value
    })
  });
  loadDashboard();
}

/* =====================================================
   SLOTS
===================================================== */
function renderSlots(slots) {
  const box = document.getElementById("slots");
  box.innerHTML = "";

  slots.forEach(s => {
    box.innerHTML += `
      <div class="slot-chip ${s.is_booked ? "booked" : ""}">
        <strong>${s.slot_date}</strong>
        <div>${s.start_time} ‚Äì ${s.end_time}</div>
        <small>${s.is_booked ? "BOOKED" : "FREE"}</small>
      </div>
    `;
  });
}

document.getElementById("slotForm").onsubmit = async e => {
  e.preventDefault();

  await api(`${BACKEND}/api/admin/slots`, {
    method: "POST",
    body: JSON.stringify({
      slot_date: slot_date.value,
      start_time: start_time.value,
      end_time: end_time.value
    })
  });

  e.target.reset();
  loadDashboard();
};

/* =====================================================
   SETTINGS
===================================================== */
document.getElementById("settingsForm").onsubmit = async e => {
  e.preventDefault();

  await api(`${BACKEND}/api/admin/settings`, {
    method: "POST",
    body: JSON.stringify({
      doctor_whatsapp: doctor_whatsapp.value,
      upi_link: upi_link.value,
      default_amount: default_amount.value
    })
  });

  alert("Settings saved");
};

loadDashboard();
setInterval(loadDashboard, 30000);
</script>

</body>
</html>
