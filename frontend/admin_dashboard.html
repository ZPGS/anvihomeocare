<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SangamKripa HomeoCare â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/style.css">
</head>

<body>

<header class="bento-header">
  <button class="hamburger" onclick="toggleMenu()">â˜°</button>
  <h2 class="page-title">Admin Dashboard</h2>
</header>

<!-- SIDE PANEL -->
<div id="sidePanel" class="side-panel">
  <h3>Doctor Settings</h3>

  <form id="settingsForm">
    <label>Doctor WhatsApp</label>
    <input id="doctor_whatsapp">

    <label>Consultation Fee (â‚¹)</label>
    <input type="number" id="default_amount">

    <label>UPI ID</label>
    <input id="upi_link">

    <button type="submit">Save</button>
    <a href="#" id="logoutBtn" class="logout-btn">Logout</a>
  </form>
</div>

<main class="dashboard">

<!-- STATS -->
<section class="stats-bento">
  <div class="stat-card total"><span>Total</span><h1 id="stat-total">0</h1></div>
  <div class="stat-card reserved"><span>Reserved</span><h1 id="stat-reserved">0</h1></div>
  <div class="stat-card confirmed"><span>Confirmed</span><h1 id="stat-confirmed">0</h1></div>
  <div class="stat-card today"><span>Today</span><h1 id="stat-today">0</h1></div>
</section>

<!-- APPOINTMENTS -->
<section class="bento appointments-box">
  <h3>Appointments</h3>
  <div id="appointments" class="appointments-scroll"></div>
</section>

<!-- SLOTS -->
<section class="bento slots-box">
  <h3>Slots</h3>

  <form id="slotForm" class="slot-form">
    <input type="date" id="slot_date" required>
    <input type="time" id="start_time" required>
    <input type="time" id="end_time" required>
    <button>Add Slot</button>
  </form>

  <div id="slots" class="slots-grid"></div>
</section>

</main>

<footer>Â© 2026 Dr. HomeoCare</footer>

<script>
/* ================= CONFIG ================= */
const BACKEND = "https://anvihomeocare.onrender.com";
const TOKEN = localStorage.getItem("admin_token");

if (!TOKEN) location.replace("/admin_login.html");

/* ================= HELPERS ================= */
function toggleMenu() {
  document.getElementById("sidePanel").classList.toggle("open");
}

async function api(url, options = {}) {
  const res = await fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + TOKEN,
      ...(options.headers || {})
    }
  });

  if (res.status === 401) {
    localStorage.removeItem("admin_token");
    location.replace("/admin_login.html");
    return null;
  }

  return res.json();
}

/* ================= LOAD DASHBOARD ================= */
async function loadDashboard() {
  const data = await api(`${BACKEND}/api/admin/dashboard`);
  if (!data) return;

  // stats
  document.getElementById("stat-total").innerText = data.stats.total;
  document.getElementById("stat-reserved").innerText = data.stats.reserved;
  document.getElementById("stat-confirmed").innerText = data.stats.confirmed;
  document.getElementById("stat-today").innerText = data.stats.today;

  // settings
  doctor_whatsapp.value = data.settings.doctor_whatsapp || "";
  default_amount.value = data.settings.default_amount || "";
  upi_link.value = data.settings.upi_link || "";

  // appointments
  const box = document.getElementById("appointments");
  box.innerHTML = "";

  data.appointments.forEach(a => {
    let waBtn = "";

    if (a.status === "RESERVED") {
      const text =
`Hello ${a.patient_name},

Your appointment has been *RESERVED* ğŸ•’

ğŸ“… Date: ${a.appointment_date}
â° Time: ${a.slot_time}

ğŸ’° Fee: â‚¹${data.settings.default_amount}

ğŸ“² Pay via UPI:
upi://pay?pa=${data.settings.upi_link}&am=${data.settings.default_amount}&cu=INR

Thank you,
Dr. Shweta Chandrakant Zungare`;

      waBtn = `
        <a class="wa-btn" target="_blank"
           href="https://api.whatsapp.com/send?phone=${a.mobile}&text=${encodeURIComponent(text)}">
          ğŸ’° Send Payment
        </a>`;
    }

    if (a.status === "CONFIRMED") {
      const text =
`Hello ${a.patient_name},

Your appointment is *CONFIRMED* âœ…

ğŸ†” Code: ${a.confirmation_code}
ğŸ“… Date: ${a.appointment_date}
â° Time: ${a.slot_time}

ğŸ”— Meeting Link:
${a.meeting_link || "Will be shared soon"}

Thank you,
Dr. Shweta Chandrakant Zungare`;

      waBtn = `
        <a class="wa-btn" target="_blank"
           href="https://api.whatsapp.com/send?phone=${a.mobile}&text=${encodeURIComponent(text)}">
          ğŸ“² Send Confirmation
        </a>`;
    }

    box.innerHTML += `
      <div class="appointment-card">
        <strong>${a.patient_name}</strong> (${a.mobile})<br>
        ${a.appointment_date} | ${a.slot_time}<br>
        <small>${a.confirmation_code}</small>

        <textarea id="r${a.id}" placeholder="Remarks">${a.admin_remarks || ""}</textarea>
        <input id="m${a.id}" placeholder="Meeting link" value="${a.meeting_link || ""}">

        <select id="s${a.id}">
          ${["RESERVED","CONFIRMED","CANCELLED","DONE"]
            .map(s => `<option ${a.status===s?"selected":""}>${s}</option>`).join("")}
        </select>

        <div class="card-actions">
          <button onclick="updateAppt(${a.id})">Update</button>
          ${waBtn}
        </div>
      </div>`;
  });

  // slots
  const sbox = document.getElementById("slots");
  sbox.innerHTML = "";
  data.slots.forEach(s => {
    sbox.innerHTML += `
      <div class="slot-chip ${s.is_booked ? "booked" : ""}">
        <strong>${s.slot_date}</strong>
        <div>${s.start_time} â€“ ${s.end_time}</div>
        <small>${s.is_booked ? "BOOKED" : "FREE"}</small>
      </div>`;
  });
}

/* ================= ACTIONS ================= */
async function updateAppt(id) {
  await api(`${BACKEND}/api/admin/update/${id}`, {
    method: "POST",
    body: JSON.stringify({
      status: document.getElementById("s"+id).value,
      meeting_link: document.getElementById("m"+id).value,
      remarks: document.getElementById("r"+id).value
    })
  });
  loadDashboard();
}

slotForm.onsubmit = async e => {
  e.preventDefault();
  await api(`${BACKEND}/api/admin/slots`, {
    method: "POST",
    body: JSON.stringify({
      slot_date: slot_date.value,
      start_time: start_time.value,
      end_time: end_time.value
    })
  });
  slotForm.reset();
  loadDashboard();
};

settingsForm.onsubmit = async e => {
  e.preventDefault();
  await api(`${BACKEND}/api/admin/settings`, {
    method: "POST",
    body: JSON.stringify({
      doctor_whatsapp: doctor_whatsapp.value,
      upi_link: upi_link.value,
      default_amount: default_amount.value
    })
  });
  alert("Saved");
};

logoutBtn.onclick = () => {
  localStorage.removeItem("admin_token");
  location.replace("/admin_login.html");
};

loadDashboard();
setInterval(loadDashboard, 30000);
</script>

</body>
</html>
