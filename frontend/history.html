<!doctype html>
<html lang="en">
<head>
  <title>Appointment History</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/style.css">
</head>

<body>

<header>
  <h2>Appointment History</h2>
</header>

<div class="container">

  <form id="historyForm">
    <input
      id="mobile"
      placeholder="Enter Mobile Number"
      required
    />
    <button type="submit">View History</button>
  </form>

  <div id="msg"></div>

  <div id="historySection" style="display:none;">
    <h3>Your Appointments</h3>

    <table>
      <thead>
        <tr>
          <th>Confirmation</th>
          <th>Date</th>
          <th>Time</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

</div>

<script>
const BACKEND = "https://anvihomeocare.onrender.com";

const historyForm = document.getElementById("historyForm");
const historyBody = document.getElementById("historyBody");
const historySection = document.getElementById("historySection");
const msg = document.getElementById("msg");
const mobileInput = document.getElementById("mobile");

function showMsg(text, type = "error") {
  msg.textContent = text;
  msg.className = "flash " + type;
}

historyForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  historyBody.innerHTML = "";
  historySection.style.display = "none";
  showMsg("");

  try {
    const res = await fetch(`${BACKEND}/api/history`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mobile: mobileInput.value.trim()
      })
    });

    const data = await res.json();

    if (!res.ok || !Array.isArray(data) || data.length === 0) {
      showMsg("No appointments found");
      return;
    }

    historySection.style.display = "block";

    data.forEach(a => {
      historyBody.innerHTML += `
        <tr>
          <td>${a.confirmation_code}</td>
          <td>${a.appointment_date}</td>
          <td>${a.slot_time}</td>
          <td class="status ${a.status}">${a.status}</td>
          <td>
            <a href="${BACKEND}/api/appointment/pdf/${a.confirmation_code}" target="_blank">
              PDF
            </a>
            ${
              a.status === "RESERVED"
                ? `<button
                     onclick="cancelAppt('${a.confirmation_code}')"
                     style="background:red;margin-left:6px;">
                     Cancel
                   </button>`
                : ""
            }
          </td>
        </tr>
      `;
    });

  } catch (err) {
    showMsg("Unable to connect to server");
  }
});

async function cancelAppt(code) {
  if (!confirm("Cancel appointment?")) return;

  try {
    await fetch(`${BACKEND}/api/cancel/${code}`, {
      method: "POST"
    });

    showMsg("Appointment cancelled", "success");
    historyForm.dispatchEvent(new Event("submit"));

  } catch (err) {
    showMsg("Failed to cancel appointment");
  }
}
</script>

</body>
</html>
