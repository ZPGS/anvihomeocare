<!doctype html>
<html>
  <head>
    <title>Appointment History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style.css" />
    <meta charset="UTF-8">

  </head>

  <body>
    <header>
      <h2>Appointment History</h2>
    </header>

    <div class="container">

      <form id="historyForm">
        <input id="mobile" placeholder="Enter Mobile Number" required />
        <button type="submit">View History</button>
      </form>

      <div id="historySection" style="display:none;">
        <h3>Your Appointments</h3>

        <table>
          <thead>
            <tr>
              <th>Confirmation</th>
              <th>Date</th>
              <th>Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>

      <div id="msg"></div>
    </div>

    <script>
      const BACKEND = "http://localhost:5000"; // CHANGE THIS TO YOUR BACKEND URL
      const historyBody = document.getElementById("historyBody");
      const historySection = document.getElementById("historySection");
      const msg = document.getElementById("msg");

      function showMsg(text, type="error") {
        msg.innerText = text;
        msg.className = "flash " + type;
      }

      document.getElementById("historyForm").addEventListener("submit", async e => {
        e.preventDefault();

        historyBody.innerHTML = "";
        historySection.style.display = "none";
        showMsg("");

        const res = await fetch(`${BACKEND}/api/history`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mobile: mobile.value })
        });

        const data = await res.json();

        if (!res.ok || !data.length) {
          showMsg("No appointments found");
          return;
        }

        historySection.style.display = "block";

        data.forEach(a => {
          historyBody.innerHTML += `
            <tr>
              <td>${a.confirmation_code}</td>
              <td>${a.appointment_date}</td>
              <td>${a.slot_time}</td>
              <td class="status ${a.status}">${a.status}</td>
              <td>
                <a href="${BACKEND}/api/appointment/pdf/${a.confirmation_code}" target="_blank">
                  PDF
                </a>
                ${
                  a.status === "RESERVED"
                    ? `<button onclick="cancelAppt('${a.confirmation_code}')"
                        style="background:red;">Cancel</button>`
                    : ""
                }
              </td>
            </tr>
          `;
        });
      });

      async function cancelAppt(code) {
        if (!confirm("Cancel appointment?")) return;

        await fetch(`${BACKEND}/api/cancel/${code}`, {
          method: "POST"
        });

        showMsg("Appointment cancelled", "success");
        historyForm.dispatchEvent(new Event("submit"));
      }
    </script>
  </body>
</html>
