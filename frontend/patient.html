<!doctype html>
<html lang="en">
<head>
  <title>Book Appointment</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/style.css">
</head>

<body>

<header>
  <h2 class="page-title">Book Your Appointment!</h2>
</header>

<div class="container">

  <div id="msg"></div>

  <h3>Patient Details</h3>

  <form id="bookForm">
    <input id="patient_name" placeholder="Full Name" required>
    <input id="mobile" placeholder="Mobile Number" required>
    <textarea
      id="address"
      placeholder="Postal Address"
      required
    ></textarea>

    <h3>Select Available Slot</h3>
    <select id="slotSelect" required>
      <option value="">Loading slots...</option>
    </select>

    <button type="submit">Reserve Appointment</button>
  </form>
</div>

<script>
const BACKEND = "https://anvihomeocare.onrender.com";

const msg = document.getElementById("msg");
const bookForm = document.getElementById("bookForm");
const slotSelect = document.getElementById("slotSelect");
const patientName = document.getElementById("patient_name");
const mobile = document.getElementById("mobile");
const address = document.getElementById("address");

function showMsg(text, type = "info") {
  msg.textContent = text;
  msg.className = "flash " + type;
}

async function loadSlots() {
  slotSelect.innerHTML = "<option>Loading slots...</option>";

  try {
    const res = await fetch(`${BACKEND}/api/slots`);
    const slots = await res.json();

    slotSelect.innerHTML = "<option value=''>Select Slot</option>";

    if (!Array.isArray(slots) || slots.length === 0) {
      slotSelect.innerHTML = "<option>No slots available</option>";
      return;
    }

    slots.forEach(s => {
      slotSelect.innerHTML += `
        <option value="${s.id}">
          ${s.slot_date} | ${s.start_time} - ${s.end_time}
        </option>`;
    });

  } catch (err) {
    showMsg("Failed to load slots", "error");
  }
}

// Book appointment
bookForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!slotSelect.value) {
    showMsg("Please select a slot", "error");
    return;
  }

  showMsg("Reserving slot...", "info");

  try {
    const res = await fetch(`${BACKEND}/api/book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        patient_name: patientName.value.trim(),
        mobile: mobile.value.trim(),
        address: address.value.trim(),
        slot_id: slotSelect.value
      })
    });

    const data = await res.json();

    if (!res.ok) {
      showMsg(data.error || "Booking failed", "error");
      return;
    }

    showMsg(
      `âœ… Appointment reserved!\nConfirmation code: ${data.confirmation_code}`,
      "success"
    );

    bookForm.reset();
    loadSlots();

  } catch (err) {
    showMsg("Unable to connect to server", "error");
  }
});

// initial load
loadSlots();
</script>

</body>
</html>
